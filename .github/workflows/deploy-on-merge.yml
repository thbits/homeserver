name: Deploy on merge

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: self-hosted
    env:
      DATADIR: ${{ vars.DATADIR }}
      DOMAIN_NAME: ${{ vars.DOMAIN_NAME }}
      SSL_EMAIL: ${{ secrets.SSL_EMAIL }}
      TIMEZONE: ${{ vars.TIMEZONE }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      STORAGE_ENCRYPTION_KEY: ${{ secrets.STORAGE_ENCRYPTION_KEY }}
    steps:
      - uses: actions/checkout@v5

      - name: Find all docker-compose files
        id: find-compose
        run: |
          # Find all compose files and sort with traefik first
          compose_dirs=$(find . -name "docker-compose.yml" -not -path "./.git/*" | xargs -I {} dirname {} | sort | awk '{if ($0 ~ /traefik/) print $0}')
          compose_dirs="$compose_dirs"$'\n'$(find . -name "docker-compose.yml" -not -path "./.git/*" | xargs -I {} dirname {} | sort | awk '{if ($0 !~ /traefik/) print $0}')
          echo "dirs<<EOF" >> $GITHUB_OUTPUT
          echo "$compose_dirs" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate all docker-compose files
        run: |
          for dir in ${{ steps.find-compose.outputs.dirs }}; do
            echo "Validating $dir/docker-compose.yml"
            (cd "$dir" && docker compose --env-file ../.env config -q)
          done

      - name: Pull latest images
        run: |
          for dir in ${{ steps.find-compose.outputs.dirs }}; do
            echo "Pulling images for $dir"
            (cd "$dir" && docker compose --env-file ../.env pull)
          done

      - name: Deploy services
        run: |
          for dir in ${{ steps.find-compose.outputs.dirs }}; do
            echo "Deploying services in $dir"
            (cd "$dir" && docker compose --env-file ../.env up -d --remove-orphans)
          done

      - name: Cleanup old images
        run: docker image prune -f
