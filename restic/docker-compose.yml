services:
  restic:
    image: instrumentisto/restic:0.18.1@sha256:b25a4783a935db3a00d7b0c2e88c357eeb7e1e4288e77ffa95cca47c2ff2cc51
    container_name: restic
    restart: unless-stopped
    networks:
      - restic
    environment:
      - TZ=${TIMEZONE}
      - RESTIC_REPOSITORY=rclone:gdrive:Backups/nullflix  # Custom path in Google Drive
      - RESTIC_PASSWORD=${RESTIC_PASSWORD}
      - RCLONE_CONFIG=/config/rclone.conf
      - RESTIC_COMPRESSION=auto
    volumes:
      # Mount paths you want to backup (read-only)
      - ${DATADIR}:/data:ro
      # Mount scripts and config
      - ${CONFIGDIR}/restic/scripts:/scripts:ro
      - ${CONFIGDIR}/restic/config:/config
      # Restic cache for better performance
      - restic-cache:/root/.cache/restic
    entrypoint: ["/bin/sh", "-c", "sleep infinity"]  # Keep container running
    labels:
      # Enable Ofelia
      - "ofelia.enabled=true"
      
      # Daily backup at 3:00 AM
      - "ofelia.job-exec.backup-daily.schedule=0 3 * * *"
      - "ofelia.job-exec.backup-daily.command=/scripts/backup.sh"
      - "ofelia.job-exec.backup-daily.user=root"
      
      # Daily prune at 3:30 AM (30 minutes after backup)
      - "ofelia.job-exec.prune-daily.schedule=30 3 * * *"
      - "ofelia.job-exec.prune-daily.command=/scripts/prune.sh"
      - "ofelia.job-exec.prune-daily.user=root"
      
      # Monthly integrity check on 1st of month at 5:00 AM
      - "ofelia.job-exec.check-monthly.schedule=0 5 1 * *"
      - "ofelia.job-exec.check-monthly.command=/scripts/check.sh"
      - "ofelia.job-exec.check-monthly.user=root"

  ofelia:
    image: mcuadros/ofelia:0.3.19@sha256:85d6aee023d1d9fe84568f5e9d0756b13153d6e25c447cc694609de1121d024b
    container_name: ofelia
    restart: unless-stopped
    depends_on:
      - restic
    networks:
      - restic
    command: daemon --docker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      ofelia.enabled: "true"

  backrest:
    image: garethgeorge/backrest:v1.10.1@sha256:1308397161321b3c5aeca8acc6bf26eccb990df385f2532d3ce0eaa8b483dedf
    container_name: backrest
    restart: unless-stopped
    environment:
      - TZ=${TIMEZONE}
      - BACKREST_DATA=/data
      - BACKREST_CONFIG=/config/config.json
      - XDG_CACHE_HOME=/cache
      # Restic configuration (auto-detected by Backrest)
      - RESTIC_REPOSITORY=rclone:gdrive:Backups/nullflix
      - RESTIC_PASSWORD=${RESTIC_PASSWORD}
      - RCLONE_CONFIG=/rclone-config/rclone.conf
    volumes:
      - ${DATADIR}/backrest/data:/data
      - ${DATADIR}/backrest/config:/config
      - ${DATADIR}/backrest/cache:/cache
      - ${DATADIR}:/backup-data:ro
      - ${CONFIGDIR}/restic/config:/rclone-config:ro
    labels:
      - traefik.enable=true
      - traefik.http.routers.backrest.rule=Host(`backrest.${DOMAIN_NAME}`)
      - traefik.http.routers.backrest.entrypoints=websecure
      - traefik.http.routers.backrest.tls=true
      - traefik.http.routers.backrest.tls.certresolver=myclouddns
      - traefik.http.services.backrest.loadbalancer.server.port=9898
      - traefik.http.routers.backrest.middlewares=geoblock@file,crowdsec-bouncer@docker,authelia-forwardauth@docker,backrest-sablier
      # Sablier configuration
      - sablier.enable=true
      - sablier.group=backrest
      - traefik.http.middlewares.backrest-sablier.plugin.sablier.group=backrest
      - traefik.http.middlewares.backrest-sablier.plugin.sablier.sablierUrl=http://sablier:10000
      - traefik.http.middlewares.backrest-sablier.plugin.sablier.sessionDuration=5m
      - traefik.http.middlewares.backrest-sablier.plugin.sablier.dynamic.displayName=Backrest
      - traefik.http.middlewares.backrest-sablier.plugin.sablier.dynamic.refreshFrequency=5s
      - traefik.http.middlewares.backrest-sablier.plugin.sablier.dynamic.showDetails=true
      - traefik.http.middlewares.backrest-sablier.plugin.sablier.dynamic.theme=ghost
      - traefik.docker.allownonrunning=true
      - homepage.group=Other
      - homepage.name=Backrest
      - homepage.icon=restic.png
      - homepage.href=https://backrest.${DOMAIN_NAME}/
      - homepage.description=Restic backup web UI
    healthcheck:
      test: ["CMD", "nc", "-vz" ,"localhost", "9898"]
      interval: 5s
      timeout: 10s
      retries: 5
    #profiles: ["manual"]
    networks:
      - restic
      - internal

networks:
  restic:
    name: restic
    driver: bridge
  internal:
    external: true

volumes:
  restic-cache:
    name: restic-cache
