services:
  pihole:
    container_name: pihole
    image: pihole/pihole:2025.10.1@sha256:4fe41ce4957b4b2e8ca8cc6edb2fd8594b7cc462f361f93993190dbf5c099664
    # For DHCP it is recommended to remove these ports and instead add: network_mode: "host"
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      # - "67:67/udp" # Only required if you are using Pi-hole as your DHCP server
      - "8086:80/tcp"
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - UMASK=002
      - TZ=${TIMEZONE}
      # - DNSMASQ_LISTENING=all
    # Volumes store your data between container upgrades
    volumes:
      - ${DATADIR}/pihole/etc-pihole:/etc/pihole
      # - ${DATADIR}/pihole/etc-dnsmasq.d:/etc/dnsmasq.d
    # dns:
    #   - 1.1.1.1
    #   - 8.8.8.8
    # https://github.com/pi-hole/docker-pi-hole#note-on-capabilities
    #  cap_add:
    #  - NET_ADMIN # Required if you are using Pi-hole as your DHCP server, else not needed
    labels:
      - traefik.enable=true
      - traefik.http.routers.pihole.rule=Host(`pihole.${DOMAIN_NAME}`)
      - traefik.http.routers.pihole.entrypoints=websecure
      - traefik.http.routers.pihole.tls=true
      - traefik.http.routers.pihole.tls.certresolver=myclouddns
      - traefik.http.services.pihole.loadbalancer.server.port=80
      # Redirect from / to /admin
      - traefik.http.middlewares.pihole-redirect.redirectregex.regex=^https?://([^/]+)/?$$
      - traefik.http.middlewares.pihole-redirect.redirectregex.replacement=https://$$1/admin/
      - traefik.http.middlewares.pihole-redirect.redirectregex.permanent=true
      - traefik.http.routers.pihole.middlewares=crowdsec-bouncer@docker,pihole-redirect,authelia-forwardauth@docker,geoblock@file
      - homepage.group=Other
      - homepage.name=Pi-hole
      - homepage.icon=pi-hole.png
      - homepage.href=http://pihole.${DOMAIN_NAME}/admin/
      - homepage.description=Network-wide Ad Blocking
      - homepage.widget.type=pihole
      - homepage.widget.url=http://pihole:80
      - homepage.widget.key=${PIHOLE_API_KEY}
      - homepage.widget.version=6
    restart: unless-stopped
    networks:
      - internal

networks:
  internal:
    external: true
