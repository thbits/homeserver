services:
  sparkyfitness-db:
    container_name: sparkyfitness-db
    image: postgres:15-alpine@sha256:b3968e348b48f1198cc6de6611d055dbad91cd561b7990c406c3fc28d7095b21
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${SPARKY_FITNESS_DB_NAME}
      - POSTGRES_USER=${SPARKY_FITNESS_DB_USER}
      - POSTGRES_PASSWORD=${SPARKY_FITNESS_DB_PASSWORD}
    volumes:
      - ${DATADIR}/sparkyfitness/postgresql:/var/lib/postgresql/data
    labels:
      - sablier.enable=true
      - sablier.group=sparkyfitness
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SPARKY_FITNESS_DB_USER} -d ${SPARKY_FITNESS_DB_NAME}"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - internal

  sparkyfitness-server:
    container_name: sparkyfitness-server
    image: codewithcj/sparkyfitness_server:v0.15.9.9@sha256:616df7065d08cd31d6142d23180908206d98bb8b55360294f116d785d802825d
    restart: unless-stopped
    depends_on:
      - sparkyfitness-db
    environment:
      - SPARKY_FITNESS_FRONTEND_URL=https://sparkyfitness.${DOMAIN_NAME}
      - SPARKY_FITNESS_DB_USER=${SPARKY_FITNESS_DB_USER}
      - SPARKY_FITNESS_DB_HOST=sparkyfitness-db
      - SPARKY_FITNESS_DB_NAME=${SPARKY_FITNESS_DB_NAME}
      - SPARKY_FITNESS_DB_PASSWORD=${SPARKY_FITNESS_DB_PASSWORD}
      - SPARKY_FITNESS_APP_DB_USER=${SPARKY_FITNESS_APP_DB_USER}
      - SPARKY_FITNESS_APP_DB_PASSWORD=${SPARKY_FITNESS_APP_DB_PASSWORD}
      - SPARKY_FITNESS_DB_PORT=5432
      - SPARKY_FITNESS_API_ENCRYPTION_KEY=${SPARKY_FITNESS_API_ENCRYPTION_KEY}
      - JWT_SECRET=${SPARKY_FITNESS_JWT_SECRET}
      - NODE_ENV=production
      - TZ=${TIMEZONE}
    volumes:
      - ${DATADIR}/sparkyfitness/backup:/app/SparkyFitnessServer/backup
      - ${DATADIR}/sparkyfitness/uploads:/app/SparkyFitnessServer/uploads
    labels:
      - sablier.enable=true
      - sablier.group=sparkyfitness
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3010/health"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - internal

  sparkyfitness-frontend:
    container_name: sparkyfitness-frontend
    image: codewithcj/sparkyfitness:v0.15.9.9@sha256:2a44975960e8f78a8b5fe441ffc7e5ffb6d50b0e67cdd1fff7d48dd66ffa768e
    restart: unless-stopped
    depends_on:
      - sparkyfitness-server
    labels:
      - traefik.enable=true
      - traefik.http.routers.sparkyfitness.rule=Host(`sparkyfitness.${DOMAIN_NAME}`)
      - traefik.http.routers.sparkyfitness.entrypoints=websecure
      - traefik.http.routers.sparkyfitness.tls=true
      - traefik.http.routers.sparkyfitness.tls.certresolver=myclouddns
      - traefik.http.routers.sparkyfitness.middlewares=geoblock@file,crowdsec-bouncer@docker,authelia-forwardauth@docker,sparkyfitness-sablier
      - traefik.http.services.sparkyfitness.loadbalancer.server.port=80
      # Sablier configuration
      - sablier.enable=true
      - sablier.group=sparkyfitness
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.group=sparkyfitness
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.sablierUrl=http://sablier:10000
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.sessionDuration=5m
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.displayName=SparkyFitness
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.refreshFrequency=5s
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.showDetails=true
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.theme=ghost
      - traefik.docker.allownonrunning=true
      - homepage.group=Other
      - homepage.name=SparkyFitness
      - homepage.icon=https://codewithcj.github.io/SparkyFitness/logo.png
      - homepage.href=https://sparkyfitness.${DOMAIN_NAME}/
      - homepage.description=Workout and fitness tracker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - internal

networks:
  internal:
    external: true
