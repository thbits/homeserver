services:
  sparkyfitness-db:
    container_name: sparkyfitness-db
    image: postgres:18.1@sha256:1090bc3a8ccfb0b55f78a494d76f8d603434f7e4553543d6e807bc7bd6bbd17f
    restart: unless-stopped
    environment:
      - POSTGRES_DB=${SPARKY_FITNESS_DB_NAME}
      - POSTGRES_USER=${SPARKY_FITNESS_DB_USER}
      - POSTGRES_PASSWORD=${SPARKY_FITNESS_DB_PASSWORD}
    volumes:
      - ${DATADIR}/sparkyfitness/postgresql:/var/lib/postgresql/data
    labels:
      - sablier.enable=true
      - sablier.group=sparkyfitness
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SPARKY_FITNESS_DB_USER} -d ${SPARKY_FITNESS_DB_NAME}"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - internal

  sparkyfitness-server:
    container_name: sparkyfitness-server
    image: codewithcj/sparkyfitness_server:v0.16.3@sha256:6fd11fcbb13f4a7391859333c59ecf8b8e0b677f00c96e36249809af7e60a5ec
    restart: unless-stopped
    depends_on:
      - sparkyfitness-db
    environment:
      - SPARKY_FITNESS_FRONTEND_URL=https://sparkyfitness.${DOMAIN_NAME}
      - SPARKY_FITNESS_DB_USER=${SPARKY_FITNESS_DB_USER}
      - SPARKY_FITNESS_DB_HOST=sparkyfitness-db
      - SPARKY_FITNESS_DB_NAME=${SPARKY_FITNESS_DB_NAME}
      - SPARKY_FITNESS_DB_PASSWORD=${SPARKY_FITNESS_DB_PASSWORD}
      - SPARKY_FITNESS_APP_DB_USER=${SPARKY_FITNESS_APP_DB_USER}
      - SPARKY_FITNESS_APP_DB_PASSWORD=${SPARKY_FITNESS_APP_DB_PASSWORD}
      - SPARKY_FITNESS_DB_PORT=5432
      - SPARKY_FITNESS_API_ENCRYPTION_KEY=${SPARKY_FITNESS_API_ENCRYPTION_KEY}
      - JWT_SECRET=${SPARKY_FITNESS_JWT_SECRET}
      - NODE_ENV=production
      - TZ=${TIMEZONE}
    volumes:
      - ${DATADIR}/sparkyfitness/backup:/app/SparkyFitnessServer/backup
      - ${DATADIR}/sparkyfitness/uploads:/app/SparkyFitnessServer/uploads
    labels:
      - sablier.enable=true
      - sablier.group=sparkyfitness
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3010/health"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - internal

  sparkyfitness-frontend:
    container_name: sparkyfitness-frontend
    image: codewithcj/sparkyfitness:v0.16.3@sha256:17fb1caaff550af89aa7d0bcd65088e2e3d04bf513743d5e4a3593817987d9ad
    restart: unless-stopped
    depends_on:
      - sparkyfitness-server
    labels:
      - traefik.enable=true
      - traefik.http.routers.sparkyfitness.rule=Host(`sparkyfitness.${DOMAIN_NAME}`)
      - traefik.http.routers.sparkyfitness.entrypoints=websecure
      - traefik.http.routers.sparkyfitness.tls=true
      - traefik.http.routers.sparkyfitness.tls.certresolver=myclouddns
      - traefik.http.routers.sparkyfitness.middlewares=geoblock@file,crowdsec-bouncer@docker,authelia-forwardauth@docker,sparkyfitness-sablier
      - traefik.http.services.sparkyfitness.loadbalancer.server.port=80
      # Sablier configuration
      - sablier.enable=true
      - sablier.group=sparkyfitness
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.group=sparkyfitness
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.sablierUrl=http://sablier:10000
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.sessionDuration=5m
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.displayName=SparkyFitness
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.refreshFrequency=5s
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.showDetails=true
      - traefik.http.middlewares.sparkyfitness-sablier.plugin.sablier.dynamic.theme=ghost
      - traefik.docker.allownonrunning=true
      - homepage.group=Other
      - homepage.name=SparkyFitness
      - homepage.icon=https://codewithcj.github.io/SparkyFitness/logo.png
      - homepage.href=https://sparkyfitness.${DOMAIN_NAME}/
      - homepage.description=Workout and fitness tracker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - internal

networks:
  internal:
    external: true
